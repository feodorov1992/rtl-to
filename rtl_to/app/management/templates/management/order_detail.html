{% block 'inner_content' %}
{% load menu_tags %}
{% load humanize %}
<div class="profile_view">
    <div>
        <h2>Детализация поручения №{{ object.inner_number }} от {{ object.order_date|date:"d.m.Y" }}</h2>
        <a href="{% url 'order_blank' order_pk=object.pk filename='ПЭ_'|add:object.filename %}" target="_blank">Скачать бланк</a>
        <a href="{% url 'order_history' pk=object.id %}?next={{ request.path }}">История статусов</a>
        {% if object.manager == request.user %}
        <a href="{% url 'docs_edit' pk=object.id %}?next={{ request.path }}">Приложить документы</a>
        <a href="{% if object.type == 'internal' %}{% url 'order_edit' pk=object.id %}{% else %}{% url 'order_edit_international' pk=object.id %}{% endif %}?next={{ request.path }}">Редактировать</a>
        <a href="{% url 'order_delete' pk=object.id %}?next={{ request.path }}">Удалить</a>
        {% else %}
        <a href="{% url 'manager_get' pk=object.pk %}?next={{ request.path }}">Взять в работу</a>
        {% endif %}
    </div>
    <div class="expandable_block">
        <div class="trigger_button"><b>Документы</b> (<span class="trigger link_styled_span">Показать</span>)</div>
        <div class="items_block">
            {% for doc in object.docs.all %}
            <div>
                <b>{{ doc.title }}</b> (<a download href="{{ doc.file.url }}">Скачать</a>)
            </div>
            {% endfor %}
        </div>
    </div>
    <div class="horizontal_tables_list">
        <table class="detail_view_table">
            <tbody>
                <tr>
                    <th>Номер поручения:</th>
                    <td>{{ object.client_number }}</td>
                </tr>
                <tr>
                    <th>Внутренний номер:</th>
                    <td>{{ object.inner_number }}</td>
                </tr>
                <tr>
                    <th>Дата поручения:</th>
                    <td>{{ object.order_date|date:"d.m.Y" }}</td>
                </tr>
                <tr>
                    <th>Создатель поручения:</th>
                    <td>{% if object.created_by %}{{ object.created_by }}{% else %}-{% endif %}</td>
                </tr>
                <tr>
                    <th>Менеджер:</th>
                    <td>{% if object.manager %}{{ object.manager }}{% else %}-{% endif %}</td>
                </tr>
                <tr>
                    <th>Заказчик:</th>
                    <td>{{ object.client }}</td>
                </tr>
                <tr>
                    <th>Наблюдатель:</th>
                    <td>{% if object.client_employee %}{{ object.client_employee }}{% else %}-{% endif %}</td>
                </tr>
                <tr>
                    <th>Договор:</th>
                    <td>{% if object.contract %}{{ object.contract }}{% else %}-{% endif %}</td>
                </tr>
                <tr>
                    <th>Сотрудник заказчика:</th>
                    <td>{% if object.client_employee %}{{ object.client_employee }}{% else %}-{% endif %}</td>
                </tr>
                <tr>
                    <th>Вид поручения:</th>
                    <td>{{ object.get_type_display }}</td>
                </tr>
                <tr>
                    <th>Ставка:</th>
                    <td>{% if object.price %}{{ object.price|intcomma }}{% else %}-{% endif %}</td>
                </tr>
                <tr>
                    <th>Закупочная цена поручения:</th>
                    <td>{% if object.price_carrier %}{{ object.price_carrier|intcomma }}{% else %}-{% endif %}</td>
                </tr>
                <tr>
                    <th>НДС:</th>
                    <td>{{ object.get_taxes_display }}</td>
                </tr>
                <tr>
                    <th>Перевыставление:</th>
                    <td>{% if object.re_submission %}Да{% else %}Нет{% endif %}</td>
                </tr>
            </tbody>
        </table>
        <table class="detail_view_table">
            <tbody>
                <tr>
                    <td colspan="2">
                        <table class="inline_table">
                            <thead>
                                <tr>
                                    <th colspan="2">Параметры грузов:</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr>
                                    <td><b>Вес брутто: </b>{{ object.weight|floatformat:-2 }} кг</td>
                                    <td><b>Кол-во мест: </b>{{ object.quantity }}</td>
                                </tr>
                            </tbody>
                        </table>
                    </td>
                </tr>
                <tr>
                    <td colspan="2">
                        <table class="inline_table">
                            <tr>
                                <th>Общее наименование груза:</th>
                                <td>{{ object.cargo_name }}</td>
                            </tr>
                            <tr>
                                <th>Страна происхождения груза:</th>
                                <td>{{ object.cargo_origin }}</td>
                            </tr>
                            <tr>
                                <th>Страхование:</th>
                                <td>{% if object.insurance %}Требуется{% else %}Не требуется{% endif %}</td>
                            </tr>
                            <tr>
                                <th>Заявленная стоимость грузов:</th>
                                <td>{% if object.value %}{{ object.value|floatformat:-2 }} {{ object.transits.first.currency }}{% else %}Не указана{% endif %}</td>
                            </tr>
                            {% if object.insurance %}
                            <tr>
                                <th>Валюта страхования:</th>
                                <td>{{ object.get_insurance_currency_display }}</td>
                            </tr>
                            <tr>
                                <th>Процент страховой суммы:</th>
                                <td>{{ object.get_sum_insured_coeff_display }}</td>
                            </tr>
                            <tr>
                                <th>Курс {{ object.transits.first.currency }}/{{ object.insurance_currency }} для расчета страховой премии:</th>
                                <td>{{ object.currency_rate }}</td>
                            </tr>
                            {% endif %}
                        </table>
                    </td>
                </tr>
                {% if object.from_date_plan or object.from_date_fact or object.from_date_wanted %}
                <tr>
                    <td colspan="2">
                        <table class="inline_table">
                            <thead>
                                <tr>
                                    <th colspan="2">Дата забора груза:</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% if object.from_date_wanted %}
                                <tr>
                                    <td><b>Желаемая: </b></td><td>{{ object.from_date_wanted|date:"d.m.Y" }}</td>
                                </tr>
                                {% endif %}
                                {% if object.from_date_plan or object.from_date_fact %}
                                <tr>
                                    {% if object.from_date_plan %}<td><b>План: </b>{{ object.from_date_plan|date:"d.m.Y" }}</td>{% endif %}
                                    {% if object.from_date_fact %}<td><b>Факт: </b>{{ object.from_date_fact|date:"d.m.Y" }}</td>{% endif %}
                                </tr>
                            {% endif %}
                            </tbody>
                        </table>
                    </td>
                </tr>
                {% endif %}
                {% if object.to_date_plan or object.to_date_fact or object.to_date_wanted %}
                <tr>
                    <td colspan="2">
                        <table class="inline_table">
                            <thead>
                                <tr>
                                    <th colspan="2">Дата доставки груза:</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% if object.to_date_wanted %}
                                <tr>
                                    <td><b>Желаемая: </b></td><td>{{ object.from_date_wanted|date:"d.m.Y" }}</td>
                                </tr>
                                {% endif %}
                                {% if object.to_date_plan or object.to_date_fact %}
                                <tr>
                                    {% if object.to_date_plan %}<td><b>План: </b>{{ object.to_date_plan|date:"d.m.Y" }}</td>{% endif %}
                                    {% if object.to_date_fact %}<td><b>Факт: </b>{{ object.to_date_fact|date:"d.m.Y" }}</td>{% endif %}
                                </tr>
                                {% endif %}
                            </tbody>
                        </table>
                    </td>
                </tr>
                {% endif %}
                {% if object.comment %}
                <tr>
                    <th>Примечания:</th>
                </tr>
                <tr>
                    {% load url_tags %}
                    <td>{{ object.comment|linebreaks|urlize|url_target_blank }}</td>
                </tr>
                {% endif %}
            </tbody>
        </table>
        <table class="detail_view_table">
            <tbody>
                <tr>
                    <th>Статус поручения:</th>
                    <td>{{ object.get_status_display }}</td>
                </tr>
            </tbody>
        </table>
    </div>
    <h2>Перевозки</h2>
    {% for transit in object.transits.all %}

    <div class="transit_tabs">
        <div class="tabs_list">
            <span class="tab_label" id="transits-{{ forloop.counter0 }}-general_tab">Общая информация</span>
            <span class="tab_label" id="transits-{{ forloop.counter0 }}-cargos_tab">Грузы</span>
            <span class="tab_label" id="transits-{{ forloop.counter0 }}-segments_tab">Исходящие поручения</span>
            <span class="tab_label" id="transits-{{ forloop.counter0 }}-history_tab">История статусов</span>
        </div>
        <div class="transit_info_block" id="transits-{{ forloop.counter0 }}-general">
            <h3>Перевозка №{{ transit.number }}</h3>
            {% if transit.from_date_fact %}
            <a href="{% url 'shipping_receipt_ext' transit_pk=transit.pk filename='ЭР_'|add:transit.filename %}?fax=true" target="_blank">ЭР (с факсимиле)</a>
            <a href="{% url 'shipping_receipt_ext' transit_pk=transit.pk filename='ЭР_'|add:transit.filename %}" target="_blank">ЭР (без факсимиле)</a>
            <br><br>
            {% endif %}
            <div  class="horizontal_tables_list" style="width: 100%">
                <table class="detail_view_table" width="30%">
                    <tr>
                        <th>Статус</th>
                        <td>{{ transit.get_status_display }}</td>
                    </tr>
                    <tr>
                        <th>Тип перевозки</th>
                        <td style="white-space: nowrap">{% if transit.type %}{{ transit.type }}{% else %}-{% endif %}</td>
                    </tr>
                    <tr>
                        <th>Заявленная стоимость груза</th>
                        <td>{% if transit.value %}{{ transit.value|floatformat:-2 }} {{ transit.currency }}{% else %}-{% endif %}</td>
                    </tr>
                    {% if object.insurance %}
                    <tr>
                        <th>Страховая сумма</th>
                        <td>{{ transit.sum_insured|floatformat:-2 }} {{ object.insurance_currency }}</td>
                    </tr>
                    <tr>
                        <th>Страховая премия</th>
                        <td>{{ transit.insurance_premium|floatformat:-2 }} {{ object.insurance_currency }}</td>
                    </tr>
                    {% endif %}
                    <tr>
                        <th>Доп. услуги</th>
                        <td>{% if transit.extra_services.exists %}{{ transit.extra_services.all|join:", " }}{% else %}-{% endif %}</td>
                    </tr>
                    <tr>
                        <th>Закупочная стоимость</th>
                        <td>{% if transit.price_carrier %}{{ transit.price_carrier|intcomma }}{% else %}-{% endif %}</td>
                    </tr>
                    <tr>
                        <th>Ставка</th>
                        <td>{% if transit.price %}{{ transit.price|floatformat:-2 }} {{ transit.price_currency }}{% else %}-{% endif %}</td>
                    </tr>
                </table>
                <table class="detail_view_table" width="70%">
                    <tbody>
                        <tr>
                            <th>Адрес забора груза</th>
                            <th>Адрес доставки</th>
                        </tr>
                        <tr>
                            <td width="50%">{{ transit.from_addr }}{% if transit.from_addr_eng %}<br>{{ transit.from_addr_eng }}{% endif %}</td>
                            <td width="50%">{{ transit.to_addr }}{% if transit.to_addr_eng %}<br>{{ transit.to_addr_eng }}{% endif %}</td>
                        </tr>
                        <tr>
                            <th>Отправитель:</th>
                            <th>Получатель:</th>
                        </tr>
                        <tr>
                            <td>{{ transit.sender }}{% if transit.sender.inn %} (ИНН {{ transit.sender.inn }}){% endif %}</td>
                            <td>{{ transit.receiver }}{% if transit.receiver.inn %} (ИНН {{ transit.receiver.inn }}){% endif %}</td>
                        </tr>
                        <tr>
                            <td><b>Контактные лица:</b><br>
                                <ul>
                                    {% for contact in transit.from_contacts.all %}
                                    <li><b>{{ contact.last_name }} {{ contact.first_name }}{% if contact.second_name %} {{ contact.second_name }}{% endif %}</b><br>
                                    <b>тел.</b> {{ contact.phone }}<br/>
                                    <b>email</b> {% if contact.email %}{{ contact.email }}{% else %}-{% endif %}</li>
                                    {% endfor %}
                                </ul>
                            </td>
                            <td><b>Контактные лица:</b><br>
                                <ul>
                                    {% for contact in transit.to_contacts.all %}
                                    <li><b>{{ contact.last_name }} {{ contact.first_name }}{% if contact.second_name %} {{ contact.second_name }}{% endif %}</b><br>
                                    <b>тел.</b> {{ contact.phone }}<br/>
                                    <b>email</b> {% if contact.email %}{{ contact.email }}{% else %}-{% endif %}</li>
                                    {% endfor %}
                                </ul>
                            </td>
                        </tr>
                        <tr>
                            {% if transit.from_date_plan or transit.from_date_fact or transit.from_date_wanted %}
                            <td>
                                <table class="inline_table">
                                    <thead>
                                        <tr>
                                            <th colspan="2">Дата забора груза:</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        {% if transit.from_date_wanted %}
                                        <tr>
                                            <td><b>Желаемая: </b></td><td>{{ transit.from_date_wanted|date:"d.m.Y" }}</td>
                                        </tr>
                                        {% endif %}
                                        {% if transit.from_date_plan or transit.from_date_fact %}
                                        <tr>
                                            {% if transit.from_date_plan %}<td><b>План: </b>{{ transit.from_date_plan|date:"d.m.Y" }}</td>{% endif %}
                                            {% if transit.from_date_fact %}<td><b>Факт: </b>{{ transit.from_date_fact|date:"d.m.Y" }}</td>{% endif %}
                                        </tr>
                                        {% endif %}
                                    </tbody>
                                </table>
                            </td>
                            {% endif %}
                            {% if transit.to_date_plan or transit.to_date_fact or transit.to_date_wanted %}
                            <td>
                                <table class="inline_table">
                                    <thead>
                                        <tr>
                                            <th colspan="2">Дата доставки груза:</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        {% if transit.to_date_wanted %}
                                        <tr>
                                            <td><b>Желаемая: </b></td><td>{{ transit.to_date_wanted|date:"d.m.Y" }}</td>
                                        </tr>
                                        {% endif %}
                                        {% if transit.to_date_plan or transit.to_date_fact %}
                                        <tr>
                                            {% if transit.to_date_plan %}<td><b>План: </b>{{ transit.to_date_plan|date:"d.m.Y" }}</td>{% endif %}
                                            {% if transit.to_date_fact %}<td><b>Факт: </b>{{ transit.to_date_fact|date:"d.m.Y" }}</td>{% endif %}
                                        </tr>
                                        {% endif %}
                                    </tbody>
                                </table>
                            </td>
                            {% endif %}
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>
        <div class="transit_info_block" id="transits-{{ forloop.counter0 }}-cargos">
            <table class="detail_view_table">
                <tbody>
                    <tr>
                        <th colspan="2">Суммарные характеристики грузов</th>
                    </tr>
                    <tr>
                        <th>
                            Вес брутто:
                        </th>
                        <td>
                            {{ transit.weight|floatformat:-2 }} кг
                        </td>
                    </tr>
                    <tr>
                        <th>
                            Объем:
                        </th>
                        <td>
                            {{ transit.volume|floatformat:-2 }} м&sup3;
                        </td>
                    </tr>
                    <tr>
                        <th>
                            Количество мест:
                        </th>
                        <td>
                            {{ transit.quantity }} шт
                        </td>
                    </tr>
                </tbody>
            </table>
            <p><b>Детализация по грузам</b></p>
            <table class="list_view_table_inactive">
                <thead>
                    <tr>
                        <td>Маркировка</td>
                        <td>Тип упаковки</td>
                        <td>Габариты (ДхШхВ), см</td>
                        <td>Вес, кг</td>
                        <td>Количество мест</td>
                        <td>Доп параметры</td>
                    </tr>
                </thead>
                <tbody>
                    {% for cargo in transit.cargos.all %}
                    <tr class="short_inactive">
                        <td>{% if cargo.mark %}{{ cargo.mark }}{% else %}-{% endif %}</td>
                        <td>{{ cargo.get_package_type_display }}</td>
                        <td>{{ cargo.length|intcomma }}x{{ cargo.width|intcomma }}x{{ cargo.height|intcomma }}</td>
                        <td>{{ cargo.weight|floatformat:-2 }}</td>
                        <td>{{ cargo.quantity }}</td>
                        <td>{% if cargo.extra_params.exists %}{{ cargo.extra_params.all|join:", " }}{% else %}-{% endif %}</td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
        <div class="transit_info_block" id="transits-{{ forloop.counter0 }}-segments">
            {% if request.user == object.manager %}
            <div>
                <a href="{% url 'ext_orders_edit' pk=transit.pk %}?next={{ request.path }}">Управление исходящими поручениями</a>
            </div>
            {% endif %}
            <br>
            {% for object in transit.ext_orders.all %}
            <div class="transit_tabs">
                <div class="tabs_list">
                    <span class="tab_label" id="transits-{{forloop.parentloop.counter0}}-extorders-{{forloop.counter0}}-general_tab">Общая информация</span>
                    <span class="tab_label" id="transits-{{forloop.parentloop.counter0}}-extorders-{{forloop.counter0}}-segments_tab">Плечи</span>
                    <span class="tab_label" id="transits-{{forloop.parentloop.counter0}}-extorders-{{forloop.counter0}}-transport_tab">Транспорт</span>
                    <span class="tab_label" id="transits-{{forloop.parentloop.counter0}}-extorders-{{forloop.counter0}}-blanks_tab">Бланки документов</span>
                    <span class="tab_label" id="transits-{{forloop.parentloop.counter0}}-extorders-{{forloop.counter0}}-originals_tab">Сканы документов</span>
                </div>
                <div class="transit_info_block" id="transits-{{forloop.parentloop.counter0}}-extorders-{{forloop.counter0}}-general">
                    <h3>Поручение №{{ object.number }}</h3>
                    <div  class="horizontal_tables_list">
                        <table class="detail_view_table">
                            <tr>
                                <th>Исполнитель:</th>
                                <td>{{ object.contractor.short_name }}</td>
                            </tr>
                            <tr>
                                <th>Договор:</th>
                                <td>{{ object.contract }}</td>
                            </tr>
                            <tr>
                                <th>Сотрудник исполнителя:</th>
                                <td>{% if object.contractor_employee %}{{ object.contractor_employee }}{% else %}-{% endif %}</td>
                            </tr>
                            <tr>
                                <th>Статус:</th>
                                <td>{{ object.get_status_display }}</td>
                            </tr>
                            <tr>
                                <th>Вес брутто:</th>
                                <td>{{ object.transit.weight|floatformat:-2 }} кг</td>
                            </tr>
                            <tr>
                                <th>Объем:</th>
                                <td>{{ object.transit.volume|floatformat:-2 }} м&sup3;</td>
                            </tr>
                            <tr>
                                <th>Количество мест:</th>
                                <td>{{ object.transit.quantity }} шт</td>
                            </tr>
                            <tr>
                                <th>Заявленная стоимость груза</th>
                                <td>{% if object.transit.value %}{{ object.transit.value|floatformat:-2 }} {{ object.transit.currency }}{% else %}-{% endif %}</td>
                            </tr>
                            <tr>
                                <th>Доп. услуги</th>
                                <td>{% if object.transit.extra_services.exists %}{{ object.transit.extra_services.all|join:", " }}{% else %}-{% endif %}</td>
                            </tr>
                            <tr>
                                <th>Ставка</th>
                                <td>{% if object.price_carrier %}{{ object.price_carrier|floatformat:-2 }} {{ object.currency }}{% else %}Не назначена{% endif %}</td>
                            </tr>
                            <tr>
                                <th>Иное</th>
                                <td>{% if object.other %}{{ object.other|linebreaks|urlize|url_target_blank }}{% else %}-{% endif %}</td>
                            </tr>
                        </table>
                        <table class="detail_view_table" width="70%">
                            <tbody>
                                <tr>
                                    <th>Адрес забора груза</th>
                                    <th>Адрес доставки</th>
                                </tr>
                                <tr>
                                    <td width="50%">{{ object.from_addr }}</td>
                                    <td width="50%">{{ object.to_addr }}</td>
                                </tr>
                                <tr>
                                    <th>Отправитель:</th>
                                    <th>Получатель:</th>
                                </tr>
                                <tr>
                                    <td>{{ object.sender }}{% if object.sender.inn %} (ИНН {{ object.sender.inn }}){% endif %}</td>
                                    <td>{{ object.receiver }}{% if object.receiver.inn %} (ИНН {{ object.receiver.inn }}){% endif %}</td>
                                </tr>
                                <tr>
                                    <td><b>Контактные лица:</b><br>
                                        <ul>
                                            {% for contact in object.from_contacts.all %}
                                            <li><b>{{ contact.last_name }} {{ contact.first_name }}{% if contact.second_name %} {{ contact.second_name }}{% endif %}</b><br>
                                            <b>тел.</b> {{ contact.phone }}<br/>
                                            <b>email</b> {% if contact.email %}{{ contact.email }}{% else %}-{% endif %}</li>
                                            {% endfor %}
                                        </ul>
                                    </td>
                                    <td><b>Контактные лица:</b><br>
                                        <ul>
                                            {% for contact in object.to_contacts.all %}
                                            <li><b>{{ contact.last_name }} {{ contact.first_name }}{% if contact.second_name %} {{ contact.second_name }}{% endif %}</b><br>
                                            <b>тел.</b> {{ contact.phone }}<br/>
                                            <b>email</b> {% if contact.email %}{{ contact.email }}{% else %}-{% endif %}</li>
                                            {% endfor %}
                                        </ul>
                                    </td>
                                </tr>
                                <tr>
                                    {% if object.from_date_plan or object.from_date_fact or object.from_date_wanted %}
                                    <td>
                                        <table class="inline_table">
                                            <thead>
                                                <tr>
                                                    <th colspan="2">Дата забора груза:</th>
                                                </tr>
                                            </thead>
                                            <tbody>
                                                {% if object.from_date_wanted %}
                                                <tr>
                                                    <td><b>Желаемая: </b></td><td>{{ object.from_date_wanted|date:"d.m.Y" }}</td>
                                                </tr>
                                                {% endif %}
                                                {% if object.from_date_plan or object.from_date_fact %}
                                                <tr>
                                                    {% if object.from_date_plan %}<td><b>План: </b>{{ object.from_date_plan|date:"d.m.Y" }}</td>{% endif %}
                                                    {% if object.from_date_fact %}<td><b>Факт: </b>{{ object.from_date_fact|date:"d.m.Y" }}</td>{% endif %}
                                                </tr>
                                            {% endif %}
                                            </tbody>
                                        </table>
                                    </td>
                                    {% endif %}
                                    {% if object.to_date_plan or object.to_date_fact or object.to_date_wanted %}
                                    <td>
                                        <table class="inline_table">
                                            <thead>
                                                <tr>
                                                    <th colspan="2">Дата доставки груза:</th>
                                                </tr>
                                            </thead>
                                            <tbody>
                                                {% if object.to_date_wanted %}
                                                <tr>
                                                    <td><b>Желаемая: </b></td><td>{{ object.to_date_wanted|date:"d.m.Y" }}</td>
                                                </tr>
                                                {% endif %}
                                                {% if object.to_date_plan or object.to_date_fact %}
                                                <tr>
                                                    {% if object.to_date_plan %}<td><b>План: </b>{{ object.to_date_plan|date:"d.m.Y" }}</td>{% endif %}
                                                    {% if object.to_date_fact %}<td><b>Факт: </b>{{ object.to_date_fact|date:"d.m.Y" }}</td>{% endif %}
                                                </tr>
                                                {% endif %}
                                            </tbody>
                                        </table>
                                    </td>
                                    {% endif %}
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
                <div class="transit_info_block" id="transits-{{forloop.parentloop.counter0}}-extorders-{{forloop.counter0}}-segments">
                    <table class="list_view_table_inactive">
                        <thead>
                            <tr>
                                <td>Маршрут</td>
                                <td>Тип перевозки</td>
                                <td>Дата отправки (план/факт)</td>
                                <td>Дата доставки (план/факт)</td>
                                <td>Кол-во мест</td>
                                <td>Оплачиваемый вес, кг</td>
                                <td>Статус</td>
                            </tr>
                        </thead>
                        <tbody>
                            {% for segment in object.segments.all %}
                            <tr>
                                <td width="30%">{{ segment }}</td>
                                <td width="5%">{{segment.get_type_display}}</td>
                                <td width="15%">{{ segment.from_date_plan|date:"d.m.Y" }}/{{ segment.from_date_fact|date:"d.m.Y" }}</td>
                                <td width="15%">{{ segment.to_date_plan|date:"d.m.Y" }}/{{ segment.to_date_fact|date:"d.m.Y" }}</td>
                                <td width="5%">{{ segment.quantity }}</td>
                                <td width="5%">{{ segment.weight_payed|floatformat:-2 }}</td>
                                <td width="10%">{{ segment.get_status_display }}</td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
                <div class="transit_info_block" id="transits-{{forloop.parentloop.counter0}}-extorders-{{forloop.counter0}}-transport">
                    {% for segment in object.segments.all %}
                    <h3>{{ segment }} ({{ segment.get_type_display }})</h3>
                    {% if segment.type == 'auto' %}
                    {% for waybill in segment.waybills.all %}
                    <table>
                        <tr>
                            <td>{{ waybill.doc_date }}{% if waybill.auto_model or waybill.auto_number %} -{% if waybill.auto_model %} {{ waybill.auto_model }}{% endif %}{% if waybill.auto_number %} {{ waybill.auto_number }}{% endif %}{% endif %} (Кол-во мест: {{ waybill.quantity }})</td>
                            <td>
                                <a href="{% url 'waybill_edit' pk=waybill.pk %}">Изменить</a>
                                <a href="{% url 'waybill_delete' pk=waybill.pk %}">Удалить</a>
                            </td>
                        </tr>
                    </table>
                    {% endfor %}
                    <a href="{% url 'waybill_data_add' segment_pk=segment.pk%}">Добавить автомобиль</a>
                    {% else %}
                    {% for waybill in segment.waybills.all %}
                    <table>
                        <tr>
                            <td>{{ waybill.doc_date }} - рейс №{{ waybill.race_number }} (Кол-во мест: {{ waybill.quantity }})</td>
                            <td>
                                <a href="{% url 'trans_doc_edit' pk=waybill.pk %}">Изменить</a>
                                <a href="{% url 'waybill_delete' pk=waybill.pk %}">Удалить</a>
                            </td>
                        </tr>
                    </table>
                    {% endfor %}
                    <a href="{% url 'trans_doc_data_add' segment_pk=segment.pk%}">Добавить рейс</a>
                    {% endif %}
                    {% endfor %}
                </div>
                <div class="transit_info_block" id="transits-{{forloop.parentloop.counter0}}-extorders-{{forloop.counter0}}-blanks">
                    <div>
                        <a href="{% url 'ext_order_blank' order_pk=object.pk filename='ПЭ_'|add:object.filename %}" target="_blank">Поручение экспедитору №{{ object.number }}</a>
                    </div>
                    {% if object.contract.pay_acc %}
                    {% if object.act_num %}
                    <div>
                        <a href="{% url 'contractor_act_blank' order_pk=object.pk filename='Акт_'|add:object.act_filename %}" target="_blank">Акт №{{ object.act_num }} от {{ object.act_date }}</a>
                    </div>
                    {% endif %}
                    {% if object.bill_num %}
                    <div>
                        <a href="{% url 'contractor_bill_blank' order_pk=object.pk filename='Счет_'|add:object.bill_filename %}" target="_blank">Счет №{{ object.bill_num }} от {{ object.bill_date }}</a>
                    </div>
                    {% endif %}{% endif %}
                    {% for segment in object.segments.all %}
                    {% if segment == segment.ext_order.segments.first or segment.type == 'auto' %}
                    <h3>{{ segment }} ({{ segment.get_type_display }})</h3>
                    <table>
                        {% for wb in segment.waybills.all %}
                        <tr>
                            <td>
                                {{ wb.doc_number }}
                            </td>
                            <td>
                                {% if segment.type == 'auto' %}
                                <a href="{% url 'waybill' docdata_pk=wb.pk filename='ТН_'|add:wb.file_name %}" target="_blank">Бланк ТН</a>
                                {% endif %}
                                {% if segment == segment.ext_order.segments.first %}
                                <a href="{% url 'shipping_receipt' docdata_pk=wb.pk filename='ЭР_'|add:wb.file_name %}" target="_blank">Бланк ЭР</a>
                                {% endif %}
                            </td>
                        </tr>
                        {% endfor %}
                    </table>
                    {% endif %}
                    {% endfor %}
                </div>
                <div class="transit_info_block" id="transits-{{forloop.parentloop.counter0}}-extorders-{{forloop.counter0}}-originals">
                    {% for segment in object.segments.all %}
                    <h3>{{ segment }} ({{ segment.get_type_display }})</h3>
                    {% if segment == segment.ext_order.segments.first and segment.receipts.exists %}
                    <table>
                        {% for receipt in segment.receipts.all %}
                        <tr>
                            <td>
                                ЭР №{{ receipt.doc_number }} от {{ receipt.doc_date|date:"d.m.Y" }}
                            </td>
                            <td>
                                <a target="_blank" download href="{{ receipt.sr_file.url }}">Скачать</a>
                                <a href="{% url 'receipt_original_edit' pk=receipt.pk %}">Изменить</a>
                                <a href="{% url 'receipt_original_delete' pk=receipt.pk %}">Удалить</a>
                            </td>
                        </tr>
                        {% endfor %}
                    </table>
                    {% endif %}
                    {% if segment == segment.ext_order.segments.first %}
                    <div><a href="{% url 'receipt_original_add' segment_pk=segment.pk %}">Добавить скан ЭР</a></div>
                    <br>
                    {% endif %}
                    {% if segment.originals.exists %}
                    <table>
                        {% for orig in segment.originals.all %}
                        <tr>
                            <td>
                                {{ orig.get_doc_type_display }} №{{ orig.doc_number }} от {{ orig.doc_date|date:"d.m.Y" }}
                            </td>
                            <td>
                                <a target="_blank" download href="{{ orig.td_file.url }}">Скачать</a>
                                <a href="{% url 'original_edit' pk=orig.pk %}">Изменить</a>
                                <a href="{% url 'original_delete' pk=orig.pk %}">Удалить</a>
                            </td>
                        </tr>
                        {% endfor %}
                    </table>
                    {% endif %}
                    <div><a href="{% url 'original_add' segment_pk=segment.pk %}">Добавить скан накладной</a></div>
                    {% if segment.randoms.exists %}
                    <table>
                        {% for random_doc in segment.randoms.all %}
                        <tr>
                            <td>
                                {{ random_doc.doc_name }} №{{ random_doc.doc_number }} от {{ random_doc.doc_date|date:"d.m.Y" }}
                            </td>
                            <td>
                                <a target="_blank" download href="{{ random_doc.rd_file.url }}">Скачать</a>
                                <a href="{% url 'random_doc_edit' pk=random_doc.pk %}">Изменить</a>
                                <a href="{% url 'random_doc_delete' pk=random_doc.pk %}">Удалить</a>
                            </td>
                        </tr>
                        {% endfor %}
                    </table>
                    {% endif %}
                    <div><a href="{% url 'random_doc_add' segment_pk=segment.pk %}">Добавить скан иного документа</a></div>
                    {% endfor %}
                </div>
            </div>
            {% endfor %}
        </div>
        <div class="transit_info_block" id="transits-{{ forloop.counter0 }}-history">
            <div>
                <a href="{% url 'transit_status_edit' pk=transit.pk %}?next={{ request.path }}">Изменить</a>
            </div>
            <br>
            <table class="detail_view_table">
                <tbody>
                    {% for status in transit.history.all %}
                    <tr>
                        <td>{{ status.created_at|date:"d.m.Y" }}</td>
                        <td>{{ status.get_status_display }}</td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
    {% endfor %}
</div>
<script>
    $(document).ready(function() {
        $('.tabs_list').each(function(){
            $(this).find('.tab_label').first().click()
        })
    })
</script>
{% endblock %}